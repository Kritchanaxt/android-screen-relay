<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Android Relay Tester</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; padding: 20px; max-width: 600px; margin: 0 auto; background-color: #f5f5f5; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h2 { margin-top: 0; color: #333; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        input[type="text"], textarea { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        button { background-color: #007AFF; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 16px; margin-right: 5px; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        button.red { background-color: #FF3B30; }
        button.green { background-color: #34C759; }
        #log { background: #333; color: #0f0; padding: 15px; border-radius: 6px; height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px; border: 1px solid #ddd; }
        .status { padding: 5px 10px; border-radius: 4px; font-size: 14px; font-weight: bold; display: inline-block; margin-bottom: 15px; }
        .status.connected { background-color: #d4edda; color: #155724; }
        .status.disconnected { background-color: #f8d7da; color: #721c24; }
    </style>
</head>
<body>

    <div class="card">
        <h2>üì° Connection</h2>
        <div id="statusBadge" class="status disconnected">Disconnected</div>
        
        <label for="urlInput">WebSocket URL:</label>
        <div style="font-size: 12px; color: #666; margin-bottom: 5px;">*Check IP Address on your Android App screen</div>
        <input type="text" id="urlInput" value="ws://192.168.1.X:8887" placeholder="ws://YOUR_ANDROID_IP:8887">
        
        <label for="passkeyInput">Passkey (Optional):</label>
        <input type="text" id="passkeyInput" placeholder="Enter 6-digit passkey">
        
        <div style="margin-top: 10px;">
            <button id="connectBtn" onclick="connect()" class="green">Connect</button>
            <button id="disconnectBtn" onclick="disconnect()" class="red" disabled>Disconnect</button>
            <span id="frameCounter" style="margin-left: 10px; font-size: 12px; color: #888; display: none;">Received Frames: 0</span>
        </div>
    </div>

    <div class="card">
        <h2>üì© Send Command</h2>
        <label>Presets:</label>
        <div style="margin-bottom: 10px;">
            <button onclick="setPayload('ping')">Ping</button>
            <button onclick="setPayload('notification')">Test Notification</button>
            <button onclick="setPayload('auth')">Auth</button>
        </div>

        <label for="payloadInput">JSON Payload:</label>
        <textarea id="payloadInput" rows="5">{"type": "ping"}</textarea>
        
        <button onclick="sendData()" id="sendBtn" disabled>Send Payload</button>
    </div>

    <div class="card">
        <h2>üìú Logs</h2>
        <div id="log"></div>
        <button onclick="document.getElementById('log').innerHTML = ''" style="margin-top: 10px; background: #666; font-size: 12px; padding: 5px 10px;">Clear Logs</button>
    </div>

    <script>
        let ws;
        const logDiv = document.getElementById('log');
        const statusBadge = document.getElementById('statusBadge');
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const sendBtn = document.getElementById('sendBtn');
        const urlInput = document.getElementById('urlInput');

        let frameCount = 0;
        const frameCounter = document.getElementById('frameCounter');
        let lastHeartbeatJSON = "";

        function connect() {
            const url = urlInput.value.trim();
            if (!url) return alert("Please enter WebSocket URL");
            
            frameCount = 0;
            updateFrameCounter(true);
            lastHeartbeatJSON = ""; 
            log("Attempting to connect to " + url + "...");
            
            try {
                ws = new WebSocket(url);

                ws.onopen = () => {
                    // Check if really open
                    if (ws.readyState === WebSocket.OPEN) {
                        updateStatus(true);
                        log("‚úÖ Connected! (Socket OPEN)");
                        
                        // Auto-auth if passkey is present
                        const passkey = document.getElementById('passkeyInput').value;
                        if(passkey) {
                            const authPacket = { type: "auth", key: passkey };
                            ws.send(JSON.stringify(authPacket));
                            log("üì§ Sent Auto-Auth: " + JSON.stringify(authPacket));
                        }
                    } else {
                        log("‚ö†Ô∏è Connection opened but state is " + getReadyStateName(ws.readyState));
                    }
                };

                ws.onmessage = (event) => {
                    if (event.data instanceof Blob) {
                        // Handle Binary Data (Image)
                        // For now, update the image count badge, but don't log every single frame
                        updateFrameCounter();
                    } else {
                        // Handle Text Data (JSON)
                        try {
                            const jsonData = JSON.parse(event.data);
                            if (jsonData.type === "heartbeat") {
                                // Create a clean object for comparison by explicitly selecting stable fields
                                // We ignore 'uptime_sec' and any top-level 'timestamp'
                                const cleanData = {};
                                
                                // Handling both nested 'data' style and flat style
                                const source = jsonData.data || jsonData;
                                
                                // Copy known stable keys that define state
                                cleanData.foreground_service = source.foreground_service;
                                cleanData.screen_capture_active = source.screen_capture_active;
                                cleanData.is_background = source.is_background;
                                // Add other stable status keys here if needed
                                
                                const currentHeartbeatStr = JSON.stringify(cleanData);
                                if (currentHeartbeatStr !== lastHeartbeatJSON) {
                                    log("üíì Heartbeat Status Changed: " + JSON.stringify(cleanData));
                                    lastHeartbeatJSON = currentHeartbeatStr;
                                }
                            } else {
                                log("üì• Received: " + event.data);
                            }
                        } catch (e) {
                             log("üì• Received: " + event.data);
                        }
                    }
                };

                ws.onclose = (event) => {
                    updateStatus(false);
                    log("‚ùå Disconnected (Code: " + event.code + ")");
                };

                ws.onerror = (error) => {
                    log("‚ö†Ô∏è Error: Check console for details");
                    console.error("WebSocket Error:", error);
                };
            } catch (e) {
                log("‚ùå Connection failed: " + e.message);
            }
        }

        function disconnect() {
            if (ws) ws.close();
        }

        function sendData() {
            if (ws) {
                if (ws.readyState === WebSocket.OPEN) {
                    const data = document.getElementById('payloadInput').value;
                    try {
                        JSON.parse(data); 
                        ws.send(data);
                        log("üì§ Sent: " + data);
                    } catch (e) {
                        log("‚ö†Ô∏è Invalid JSON format, sending anyway...");
                        ws.send(data);
                    }
                } else {
                     log("‚ö†Ô∏è Socket State is " + getReadyStateName(ws.readyState) + " (Not Open)");
                }
            } else {
                log("‚ö†Ô∏è WebSocket object is null");
            }
        }

        function getReadyStateName(state) {
            switch (state) {
                case WebSocket.CONNECTING: return "CONNECTING";
                case WebSocket.OPEN: return "OPEN";
                case WebSocket.CLOSING: return "CLOSING";
                case WebSocket.CLOSED: return "CLOSED";
                default: return "UNKNOWN";
            }
        }

        function updateStatus(isConnected) {
            const frameCounterSpan = document.getElementById('frameCounter');
            if (isConnected) {
                statusBadge.textContent = "Connected";
                statusBadge.className = "status connected";
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
                sendBtn.disabled = false;
                urlInput.disabled = true;
                frameCounterSpan.style.display = 'inline-block';
            } else {
                statusBadge.textContent = "Disconnected";
                statusBadge.className = "status disconnected";
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
                sendBtn.disabled = true;
                urlInput.disabled = false;
                frameCounterSpan.style.display = 'none';
            }
        }

        function log(msg) {
            const time = new Date().toLocaleTimeString();
            logDiv.innerHTML += `<div>[${time}] ${msg}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function setPayload(type) {
            const output = document.getElementById('payloadInput');
            if (type === 'ping') {
                output.value = JSON.stringify({ type: "ping", timestamp: Date.now() }, null, 2);
            } else if (type === 'notification') {
                output.value = JSON.stringify({ 
                    type: "notification", 
                    title: "Hello from Web!", 
                    message: "This confirms background connection working." 
                }, null, 2);
            } else if (type === 'auth') {
                const pass = document.getElementById('passkeyInput').value || "123456";
                output.value = JSON.stringify({ type: "auth", key: pass }, null, 2);
            }
        }
        function updateFrameCounter(start = false) {
            if(start) {
                frameCounter.style.display = 'inline-block';
                frameCounter.innerText = "Frames: 0";
            } else {
                frameCount++;
                frameCounter.innerText = "Frames: " + frameCount;
            }
        }
    </script>
</body>
</html>